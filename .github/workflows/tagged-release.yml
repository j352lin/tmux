---
name: "tagged-release"

on:
  push:
    tags:
      - "*"

jobs:
  gh_tagged_release:
    runs-on: "ubuntu-latest"
    env:
      JEST_VERBOSE: ${{ secrets.JEST_VERBOSE }}

    steps:
      - name: "Checkout source code"
        uses: "actions/checkout@v2.3.4"
        with:
          lfs: true
          fetch-depth: 0

      - id: "yarn-cache"
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: "actions/cache@v2.1.6"
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - run: "sudo apt-get update -qq"
      - run: "sudo apt-get -y install bison \
          autotools-dev \
          libncurses5-dev \
          libevent-dev \
          pkg-config \
          libutempter-dev \
          build-essential"
      - run: "sh .github/travis/before-install.sh"
      - run: "sh .github/travis/build.sh"
      - run: "make dist"

      - run: "NEW_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)"
      - run: "PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))"

      - run: "git log --pretty=format:'%s' $PREV_TAG..HEAD > /tmp/tmux-tagged-release"
      - run: "sed 's/^/* /' /tmp/tmux-tagged-release > /tmp/tmux-tagged-release"
      - run: "echo CHANGES FROM $PREV_TAG to $NEW_tag | cat - /tmp/tmux-tagged-release > /tmp/tmp_file"
      - run: "cat /tmp/tmp_file > /tmp/tmux-tagged-release"
      - run: "sed G /tmp/tmux-tagged-release > /tmp/tmux-tagged-release"
      - run: "cat /tmp/tmux-tagged-release | cat - CHANGES > /tmp/tmp_file"
      - run: "cat /tmp/tmp_file > CHANGES"
      - run: "rm /tmp/tmux-tagged-release"
      - run: "rm /tmp/tmp_file"

      - run: "git config user.name 'GitHub Actions'"
      - run: "git config user.email 'actions@github.com'"
      - run: "git add CHANGES"
      - run: "git commit -m 'change CHANGES for new release'"
      - run: "git push"

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "$NEW_TAG"
          prerelease: false
          files: |
            *.tar.gz
        id: "automatic_releases"
